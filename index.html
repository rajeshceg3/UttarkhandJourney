<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore & Plan Your Trip to Uttarakhand</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- Google Fonts: Playfair Display & Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Feather Icons for UI elements -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* --- Base & Typography --- */
        :root {
            --primary-bg: #FFFFFF;
            --secondary-bg: #F0F4F8;
            --secondary-bg-hover: #E5E9ED;
            --primary-text: #1A202C;
            --secondary-text: #4A5568;
            --accent-color: #3182CE;
            --accent-color-dark: #2B6CB0;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3, h4, h5, h6 { font-family: 'Playfair Display', serif; }

        /* --- Dark Mode --- */
        body.dark-mode {
            --primary-bg: #1A202C;
            --secondary-bg: #2D3748;
            --secondary-bg-hover: #4A5568;
            --primary-text: #F7FAFC;
            --secondary-text: #A0AEC0;
            --accent-color: #4299E1;
            --accent-color-dark: #2B6CB0;
        }

        /* --- Layout --- */
        .main-layout { display: grid; grid-template-columns: 350px 1fr; height: 100vh; }
        #map { height: 100%; width: 100%; background-color: #E0E5EC; }
        
        /* --- Animations & Transitions --- */
        .fade-in { animation: fadeIn 1s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .subtle-btn { transition: all 0.2s ease-in-out; }
        .subtle-btn:hover { transform: scale(1.05); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(20px); }
        }
        @keyframes icon-pop {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .itinerary-item.adding { animation: slideIn 0.3s ease forwards; }
        .itinerary-item.removing { animation: slideOut 0.3s ease forwards; }
        .add-sidebar-btn .feather-check-circle { animation: icon-pop 0.3s ease-in-out; }

        /* --- Sidebar & Location List --- */
        .sidebar { background-color: var(--secondary-bg); padding: 2rem; overflow-y: auto; transition: transform 0.3s ease-in-out; }
        .location-item { transition: all 0.2s ease-in-out; border-left: 4px solid transparent; }
        .location-item:hover { background-color: var(--secondary-bg-hover); border-left-color: var(--accent-color); transform: translateX(5px); }
        .location-item.active { background-color: var(--secondary-bg-hover); border-left-color: var(--accent-color-dark); }

        /* --- Filter Buttons --- */
        .filter-btn { transition: all 0.2s ease-in-out; border: 1px solid transparent; }
        .filter-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .filter-btn.active { border-color: var(--accent-color); background-color: var(--accent-color-dark); color: white; }

        /* --- Itinerary Panel --- */
        #itinerary-panel h2 { border-top: 1px solid #D1CBB8; padding-top: 1.5rem; margin-top: 1.5rem; }
        #itinerary-panel {
            border-top: 2px solid var(--secondary-bg-hover);
        }
        .itinerary-item {
            background-color: var(--primary-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .itinerary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .itinerary-item .remove-btn svg {
            transition: color 0.2s ease;
        }
        .itinerary-item .remove-btn:hover svg {
            color: #E53E3E; /* A brighter red for hover */
        }

        /* --- Custom Marker & Popup --- */
        @keyframes marker-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .custom-marker-icon {
            transition: transform 0.2s ease-in-out;
            animation: marker-bounce 2s infinite;
        }
        .custom-marker-icon:hover { transform: scale(1.2); }
        .leaflet-popup-content-wrapper { background-color: var(--primary-bg); color: var(--primary-text); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .leaflet-popup-content { margin: 0; width: 250px !important; }
        .leaflet-popup-tip-container { display: none; }
        .popup-title { font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 700; }
        .popup-image { border-radius: 8px 8px 0 0; }
        .add-to-trip-btn { background-color: var(--accent-color); color: white; }
        .add-to-trip-btn:disabled { background-color: #63B3ED; cursor: not-allowed; }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { position: absolute; top: 0; left: 0; bottom: 0; width: 300px; z-index: 1001; transform: translateX(-100%); box-shadow: 2px 0 15px rgba(0,0,0,0.1); }
            .sidebar.open { transform: translateX(0); }
            .mobile-toggle { display: block; }
        }

        /* --- Location Details Modal --- */
        #location-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        #location-modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Location Detail Modal -->
    <div id="location-modal">
        <div class="modal-content">
            <button class="modal-close-btn">
                <i data-feather="x" class="w-8 h-8 text-gray-600"></i>
            </button>
            <div id="modal-body">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fade-in flex flex-col">
            <div class="flex-grow">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-primary-text">Explore Uttarakhand</h1>
                    <p class="text-md text-secondary-text mt-2">The Land of the Gods</p>
                </div>

                <div id="filter-container" class="flex justify-center space-x-2 mb-6">
                    <button data-filter="all" class="filter-btn active px-4 py-2 text-sm font-semibold rounded-full bg-accent-color-dark text-white shadow">All</button>
                    <button data-filter="pilgrimage" class="filter-btn px-4 py-2 text-sm font-semibold rounded-full bg-white text-primary-text shadow">Pilgrimage</button>
                    <button data-filter="hill-station" class="filter-btn px-4 py-2 text-sm font-semibold rounded-full bg-white text-primary-text shadow">Hill Station</button>
                    <button data-filter="park" class="filter-btn px-4 py-2 text-sm font-semibold rounded-full bg-white text-primary-text shadow">Park</button>
                </div>

                <div id="location-list" class="space-y-2">
                    <!-- Location items will be injected here by JS -->
                </div>
            </div>
            
            <!-- Itinerary Panel -->
            <div id="itinerary-panel" class="mt-auto pt-6">
                <h2 class="text-2xl font-bold text-primary-text text-center mb-4">My Trip Plan</h2>
                <div id="itinerary-list" class="space-y-3">
                    <!-- Itinerary items will be injected here -->
                </div>
                <p id="itinerary-empty" class="text-center text-secondary-text italic p-4">Your trip is empty. Add locations to get started!</p>
                <button id="clear-itinerary-btn" class="w-full mt-4 py-2 px-4 rounded-lg text-white bg-red-500 hover:bg-red-600 subtle-btn" style="display: none;">Clear Trip</button>
            </div>
        </div>
        <div class="p-4 flex justify-end items-center">
             <span class="text-sm text-secondary-text mr-2">Dark Mode</span>
            <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
            </label>
        </div>
        </aside>

        <!-- Map Container -->
        <main id="map-container" class="relative">
            <div id="map"></div>
            <button id="mobile-toggle" class="mobile-toggle hidden absolute top-4 left-4 z-[1000] bg-white p-2 rounded-md shadow-lg">
                <i data-feather="menu"></i>
            </button>
        </main>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- State ---
            let itinerary = [];

            // --- Data ---
            const locations = [
                { id: 'dehradun', lat: 30.3165, lng: 78.0322, title: 'Dehradun', description: 'The capital city, nestled in the Doon Valley.', image: 'https://placehold.co/400x300/A7C7E7/FFFFFF?text=Dehradun', type: 'city' },
                { id: 'haridwar', lat: 29.9457, lng: 78.1642, title: 'Haridwar', description: 'A holy city where the River Ganges enters the plains.', image: 'https://placehold.co/400x300/F8C8DC/FFFFFF?text=Haridwar', type: 'pilgrimage' },
                { id: 'rishikesh', lat: 30.1314, lng: 78.2913, title: 'Rishikesh', description: 'Known as the "Yoga Capital of the World".', image: 'https://placehold.co/400x300/B2D8B2/FFFFFF?text=Rishikesh', type: 'pilgrimage' },
                { id: 'nainital', lat: 29.3803, lng: 79.4636, title: 'Nainital', description: 'A charming hill station built around Naini Lake.', image: 'https://placehold.co/400x300/E6E6FA/FFFFFF?text=Nainital', type: 'hill-station' },
                { id: 'mussoorie', lat: 30.4593, lng: 78.0729, title: 'Mussoorie', description: 'The "Queen of the Hills," with stunning Himalayan views.', image: 'https://placehold.co/400x300/FFDAB9/FFFFFF?text=Mussoorie', type: 'hill-station' },
                { id: 'badrinath', lat: 30.7423, lng: 79.4934, title: 'Badrinath', description: 'A sacred pilgrimage site dedicated to Lord Vishnu.', image: 'https://placehold.co/400x300/C3B1E1/FFFFFF?text=Badrinath', type: 'pilgrimage' },
                { id: 'kedarnath', lat: 30.6046, lng: 79.0659, title: 'Kedarnath', description: 'Home to the ancient Kedarnath Temple.', image: 'https://placehold.co/400x300/F5DEB3/FFFFFF?text=Kedarnath', type: 'pilgrimage' },
                { id: 'corbett', lat: 29.5845, lng: 79.4565, title: 'Jim Corbett NP', description: 'India\'s oldest national park, home to the Bengal tiger.', image: 'https://placehold.co/400x300/98FB98/FFFFFF?text=Corbett', type: 'park' },
                { id: 'valley_of_flowers', lat: 30.6976, lng: 79.5663, title: 'Valley of Flowers', description: 'A vibrant national park with alpine flowers.', image: 'https://placehold.co/400x300/FFB6C1/FFFFFF?text=Valley+of+Flowers', type: 'park' },
                { id: 'auli', lat: 30.5293, lng: 79.5639, title: 'Auli', description: 'A premier ski destination with panoramic views.', image: 'https://placehold.co/400x300/ADD8E6/FFFFFF?text=Auli', type: 'hill-station' }
            ];

            // --- Map Initialization ---
            const map = L.map('map', { center: [30.0668, 79.0193], zoom: 8, zoomControl: false });
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>' }).addTo(map);

            // --- Icons ---
            const icons = {
                'hill-station': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3L2 21h20L12 3zM8.5 14l2.5 3 3-4.5 2.5 3.5"/></svg>`,
                'pilgrimage': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
                'park': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.9 10.9c-1.3 3.3-3.3 6.6-6.4 9.3-2.3 2-4.8 3.3-7.5 3.8-1.1.2-2.2-.4-2.7-1.4s-.2-2.3.6-3.1c.9-.9 2.1-1.5 3.4-1.9 2.2-.7 4.5-2 6.5-3.8 2.2-2 4-4.5 5.2-7.4.4-1 .1-2.2-.8-2.8-.9-.6-2.1-.4-2.8.5-1.1 1.4-2.4 3.1-3.7 4.8m-2.1-2.1c-.2.2-.4.4-.6.6"></path></svg>`,
                'city': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`
            };

            const locationListEl = document.getElementById('location-list');
            const itineraryListEl = document.getElementById('itinerary-list');
            const itineraryEmptyEl = document.getElementById('itinerary-empty');
            const clearItineraryBtn = document.getElementById('clear-itinerary-btn');
            const filterContainer = document.getElementById('filter-container');
            const markers = {};

            // --- Core Functions ---
            const renderItinerary = () => {
                const existingIds = Array.from(itineraryListEl.children).map(item => item.dataset.id);

                // Add new items
                itinerary.forEach(locationId => {
                    if (!existingIds.includes(locationId)) {
                        const location = locations.find(l => l.id === locationId);
                        const item = document.createElement('div');
                        item.className = 'itinerary-item flex items-center justify-between p-3 adding';
                        item.dataset.id = location.id;
                        item.innerHTML = `
                            <span class="font-semibold text-primary-text">${location.title}</span>
                            <button class="remove-btn p-1" data-id="${location.id}">
                                <i data-feather="x" class="w-5 h-5 text-secondary-text"></i>
                            </button>
                        `;
                        itineraryListEl.appendChild(item);
                        setTimeout(() => item.classList.remove('adding'), 500);
                    }
                });

                // Update visibility
                itineraryEmptyEl.style.display = itinerary.length === 0 ? 'block' : 'none';
                clearItineraryBtn.style.display = itinerary.length === 0 ? 'none' : 'block';

                updateButtonStates();
                feather.replace();
            };

            const updateButtonStates = () => {
                document.querySelectorAll('[data-add-id]').forEach(btn => {
                    const id = btn.dataset.addId;
                    const isAdded = itinerary.includes(id);

                    if (btn.tagName === 'BUTTON') { // Popup button
                        btn.disabled = isAdded;
                        if (isAdded) {
                            btn.innerHTML = `<i data-feather="check" class="w-5 h-5 mr-2"></i>Added`;
                            btn.classList.add('bg-green-500', 'hover:bg-green-600');
                            btn.classList.remove('bg-accent-color', 'hover:bg-accent-color-dark');
                        } else {
                            btn.innerHTML = `Add to Trip`;
                             btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                            btn.classList.add('bg-accent-color', 'hover:bg-accent-color-dark');
                        }
                    } else { // Sidebar button
                        const icon = isAdded ? 'check-circle' : 'plus-circle';
                        const color = isAdded ? 'text-green-500' : 'text-accent-color';
                        if (!btn.innerHTML.includes(icon)) {
                            btn.innerHTML = `<i data-feather="${icon}" class="w-6 h-6 ${color}"></i>`;
                            if (isAdded) {
                                btn.classList.add('add-sidebar-btn');
                            }
                        }
                    }
                });
                feather.replace();
            };

            const saveItinerary = () => {
                localStorage.setItem('tripItinerary', JSON.stringify(itinerary));
            };

            const loadItinerary = () => {
                const savedItinerary = localStorage.getItem('tripItinerary');
                if (savedItinerary) {
                    itinerary = JSON.parse(savedItinerary);
                }
            };

            const addToItinerary = (id) => {
                if (!itinerary.includes(id)) {
                    itinerary.push(id);
                    renderItinerary();
                    saveItinerary();
                }
            };
            
            const removeFromItinerary = (id) => {
                const item = itineraryListEl.querySelector(`[data-id="${id}"]`);
                if (item) {
                    item.classList.add('removing');
                    setTimeout(() => {
                        itinerary = itinerary.filter(itemId => itemId !== id);
                        item.remove();
                        renderItinerary();
                        saveItinerary();
                    }, 300);
                }
            };

            const filterLocations = (type) => {
                locations.forEach(loc => {
                    const locationItem = document.querySelector(`.location-item[data-id="${loc.id}"]`);
                    const marker = markers[loc.id];
                    const show = (type === 'all' || loc.type === type);

                    if (locationItem) locationItem.style.display = show ? 'flex' : 'none';
                    if (marker) {
                        if (show) {
                            if (!map.hasLayer(marker)) map.addLayer(marker);
                        } else {
                            if (map.hasLayer(marker)) map.removeLayer(marker);
                        }
                    }
                });

                // Update active button style
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === type);
                     if (btn.dataset.filter === type) {
                        btn.style.backgroundColor = 'var(--accent-color-dark)';
                        btn.style.color = 'white';
                    } else {
                        btn.style.backgroundColor = 'var(--primary-bg)';
                        btn.style.color = 'var(--primary-text)';
                    }
                });
            };

            // --- Event Listeners ---
            filterContainer.addEventListener('click', (e) => {
                const filterButton = e.target.closest('.filter-btn');
                if (filterButton) {
                    filterLocations(filterButton.dataset.filter);
                }
            });
            clearItineraryBtn.addEventListener('click', () => {
                itinerary = [];
                renderItinerary();
                saveItinerary();
            });

            itineraryListEl.addEventListener('click', (e) => {
                const removeButton = e.target.closest('.remove-btn');
                if (removeButton) {
                    removeFromItinerary(removeButton.dataset.id);
                }
            });

            const modal = document.getElementById('location-modal');
            const modalBody = document.getElementById('modal-body');
            const closeModalBtn = document.querySelector('.modal-close-btn');

            const openModal = (location) => {
                modalBody.innerHTML = `
                    <h2 class="text-3xl font-bold mb-4">${location.title}</h2>
                    <img src="${location.image}" alt="${location.title}" class="w-full h-64 object-cover rounded-lg mb-4">
                    <p class="text-lg">${location.description}</p>
                    <p class="text-sm text-gray-500 mt-4">Type: ${location.type}</p>
                `;
                modal.classList.add('show');
                feather.replace();
            };

            const closeModal = () => {
                modal.classList.remove('show');
            };

            map.on('popupopen', (e) => {
                const moreInfoBtn = e.popup.getElement().querySelector('.more-info-btn');
                if (moreInfoBtn) {
                    moreInfoBtn.addEventListener('click', () => {
                        const locationId = moreInfoBtn.dataset.id;
                        const location = locations.find(l => l.id === locationId);
                        openModal(location);
                    });
                }
            });

            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            // --- Initial Population ---
            locations.forEach((loc, index) => {
                // Add to sidebar
                const item = document.createElement('div');
                item.className = 'location-item p-4 rounded-lg cursor-pointer fade-in flex justify-between items-center';
                item.dataset.id = loc.id;
                item.style.animationDelay = `${index * 50}ms`;
                item.innerHTML = `
                    <div>
                        <h3 class="font-bold text-lg">${loc.title}</h3>
                        <p class="text-sm text-gray-600">${loc.description}</p>
                    </div>
                    <button class="add-sidebar-btn p-1 subtle-btn" data-add-id="${loc.id}"></button>
                `;
                item.querySelector('div').addEventListener('click', () => {
                    map.flyTo([loc.lat, loc.lng], 13);
                    markers[loc.id].openPopup();
                });
                item.querySelector('.add-sidebar-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    addToItinerary(loc.id);
                });
                locationListEl.appendChild(item);

                // Add marker to map
                const customIcon = L.divIcon({ html: `<div class="custom-marker-icon">${icons[loc.type] || icons['city']}</div>`, className: '', iconSize: [28, 28], iconAnchor: [14, 28], popupAnchor: [0, -28] });
                const marker = L.marker([loc.lat, loc.lng], { icon: customIcon }).addTo(map);
                marker.bindPopup(L.popup({closeButton: false}).setContent(`
                    <div>
                        <img src="${loc.image}" alt="${loc.title}" class="popup-image w-full h-32 object-cover">
                        <div class="p-4">
                            <h3 class="popup-title">${loc.title}</h3>
                            <p class="text-sm my-2">${loc.description}</p>
                            <button class="add-to-trip-btn w-full py-2 px-4 rounded-lg font-semibold text-sm subtle-btn" data-add-id="${loc.id}">Add to Trip</button>
                            <button class="more-info-btn w-full mt-2 py-2 px-4 rounded-lg font-semibold text-sm bg-gray-200 text-gray-700 subtle-btn" data-id="${loc.id}">More Info</button>
                        </div>
                    </div>
                `));

                marker.on('click', () => {
                    document.querySelectorAll('.location-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                });
                
                marker.getPopup().on('add', () => {
                    updateButtonStates();
                    document.querySelector(`.leaflet-popup-content button[data-add-id="${loc.id}"]`).addEventListener('click', () => {
                        addToItinerary(loc.id);
                    });
                });

                markers[loc.id] = marker;
            });
            
            // --- Mobile Sidebar Toggle ---
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('mobile-toggle');
            toggleButton.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('open'); });
            document.getElementById('map').addEventListener('click', () => { if (sidebar.classList.contains('open')) sidebar.classList.remove('open'); });

            // --- Dark Mode ---
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const body = document.body;

            const enableDarkMode = () => {
                body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'enabled');
                darkModeToggle.checked = true;
            };

            const disableDarkMode = () => {
                body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'disabled');
                darkModeToggle.checked = false;
            };

            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    enableDarkMode();
                } else {
                    disableDarkMode();
                }
            });

            if (localStorage.getItem('darkMode') === 'enabled') {
                enableDarkMode();
            }


            // --- Load, Render, and Init ---
            loadItinerary();
            renderItinerary();
            feather.replace();
        });
    </script>
</body>
</html>
